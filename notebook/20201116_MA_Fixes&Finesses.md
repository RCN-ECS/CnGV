# Fixes and Finesses

This post is in response to this [previous post](https://github.com/RCN-ECS/CnGV/blob/master/notebook/20201109_KEL_MA_meetingnotes.md) in which Molly went through a few lingering issues with the simulations. 

## Issue #1. GxE p-values 
The p-values for the raw data were alarmingly different from the p-values generated by the ANOVA, although some discrpancy is expected. One potential reason is that I was still testing the null that GxE = 0, not that GxE = G+E, like i had implemented with the means data. 
So I re-coded the null hypothesis for the raw data into the following: 

```{G+E permutation code}

 allGE <- NULL
    for (i in 1:nlevels(input_df$gen_factor)){
      for (j in 1:nlevels(input_df$exp_env_factor)){
        
        G_levels <- levels(input_df$gen_factor)
        E_levels <- levels(input_df$exp_env_factor)
        
        Gi_mean <- mean(sample(input_df$phen_corrected[input_df$gen_factor == G_levels[i]], 
                               size = length(input_df$phen_corrected[input_df$gen_factor == G_levels[i]]),
                               replace = TRUE))
        Ej_mean <- mean(sample(input_df$phen_corrected[input_df$exp_env_factor == E_levels[j]],
                               size = length(input_df$phen_corrected[input_df$exp_env_factor == E_levels[j]]),
                               replace = TRUE))
        GE_sd <- input_df %>%
          filter(gen_factor == G_levels[i]) %>%
          filter(exp_env_factor == E_levels[j]) %>%
          summarize("GEsd" = mean(e))

        # Create a sample of the null expectation for the Gi+Ej
        set.seed = seed
        GiEj_null_samp <- rnorm(1, mean = (Gi_mean + Ej_mean), sd = abs(GE_sd[[1]]))
        
        # Estimate 
        GxE_mean.temp <- abs(GiEj_null_samp - # G+E (Phenotype of ith genotype in jth environment)
                             Gi_mean - # mean phenotype of ith Genotype
                             Ej_mean + # mean phenotype of jth Environment
                             mean(input_df$phen_corrected)) # Overall mean
        allGE <- c(allGE, GxE_mean.temp)
      }
    }
    
    GxE_emm_loop = mean(allGE)
```
